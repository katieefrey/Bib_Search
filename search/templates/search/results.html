{% extends "search/base.html" %}
{% load static %}
{% load tags %}

{% block nav-history %}active{% endblock %}

{% block title %}
    CfA Bibliography
{% endblock %}

{% block body %}

<div id="home" class="container-fluid">
    <div class="row py-md-3 pl-md-5">
        <h2>CfA Bibliography Author Search Report {{resultset.id}}</h2>
        <br>
    </div>
    

    <div class="row">

    <div class="col-12 col-md-3 col-xl-2 py-md-3 pl-md-5 bd-sidebar section-nav">

        <h4>Search Query</h4>
        <strong>Report Created:</strong><br/>
            {{resultset.created}}
            <br/><br/>
            <strong>Date Range:</strong><br/>
            {{resultset.daterange}}
            <br/><br/>
            <strong>Bibgroup:</strong><br/>
            {{resultset.bibgroup}}
            <br/><br/>
            <strong>Author List:</strong><br/>
            {% for a in allauths %}
                {{a}}<br/>
            {% endfor %}
            <br/><br/>
    </div>
        
    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 bd-content" role="main">

        <h4>Tabular Data</h4>
        <table border="0">
            <tr>
                <td>

        <form action="/export_author" method="post">
            {% csrf_token %}

            <input type="hidden" name="reid" value="{{resultset.id}}">
            <button type="submit" class="btn btn-primary">Export Author Statistics</button>
        </form>
    </td>
    <td>&nbsp;&nbsp;</td>
    <td>
        <form action="/export_journal" method="post">
            {% csrf_token %}

            <input type="hidden" name="reid" value="{{resultset.id}}">
            <button type="submit" class="btn btn-primary">Export Journal Statistics</button>
        </form>
</td></tr></table>
        <br/><br/>

        <h4>Graphs</h4>

        <div id="authorgraph"></div>
        <div id="journalgraph"></div>

        <table border=1>
        {% for x in authors reversed %}
        
            <tr>
                <td><strong><a target="_blank" href="https://ui.adsabs.harvard.edu/search/q=%20author%3A%22{{x.aname}}%22%20%20bibgroup%3A%22{{resultset.bibgroup}}%22%20%20pubdate%3A%5B{{resultset.daterange}}%5D&sort=date%20desc%2C%20bibcode%20desc&p_=0">{{x.aname}} (ADS)</a></strong></td>
                <td>
                    <table border=1>
                        <tr>
                            <td></td>
                            <th>Articles</th>
                            <th>First Author</th>
                            <th>Citations</th>
                        </tr>
                        <tr>
                            <td>Refereed</td>
                            <td>{{x.rart}}</td>
                            <td>{{x.rfirst}}</td>
                            <td>{{x.rcite}}</td>
                        </tr>
                        <tr>
                            <td>Non Refereed</td>
                            <td>{{x.nrart}}</td>
                            <td>{{x.nrfirst}}</td>
                            <td>{{x.nrcite}}</td>
                        </tr>
                        <tr>
                            <td>Total</td>
                            <td>{{ x.rart|add:x.nrart }}</td>
                            <td>{{ x.rfirst|add:x.nrfirst }}</td>
                            <td>{{ x.rcite|add:x.nrcite }}</td>
                        </tr>

                    </table>
                    <br/>
            </tr>
        
        {% endfor %}
        </table>

        <br/><br/>



        <table border=1>
            <tr>
                <th>Author Name</th>
                <th>Total Articles</th>
                <th>Total Citations</th>
                <th>Refereed Articles</th>
                <th>Refereed Citations</th>
                <th>Non Refereed Articles</th>
                <th>Non Refereed Citations</th>
            </tr>
            {% for x in authors %}
                <tr>
                    <td>{{x.aname}}</td>
                    <td>{{ x.rart|add:x.nrart }}</td>
                    <td>{{ x.rcite|add:x.nrcite }}</td>
                    <td>{{x.rart}}</td>
                    <td>{{x.rcite}}</td>
                    <td>{{x.nrart}}</td>
                    <td>{{x.nrcite}}</td>
                </tr>
        {% endfor %}
        </table>

    </main>

</div>
</div>

<script>
var trace1 = {
  x: [{% for x in authors %}{{x.rfirst}},{% endfor %}],
  y: [{% for x in authors %}'{{x.aname}}',{% endfor %}],
  name: 'First Author, Refereed',
  orientation: 'h',
  type: 'bar',
  marker: {
    color: 'rgba(55,128,191,1)',
    width: 1
  }
};

var trace2 = {
  x: [{% for x in authors %}{{x.rart|subtract:x.rfirst}},{% endfor %}],
  y: [{% for x in authors %}'{{x.aname}}',{% endfor %}],
  name: 'Refereed',
  orientation: 'h',
  marker: {
    color: 'rgba(55,128,191,0.6)',
    width: 1
  },
  type: 'bar'
};

var trace3 = {
  x: [{% for x in authors %}{{x.nrfirst}},{% endfor %}],
  y: [{% for x in authors %}'{{x.aname}}',{% endfor %}],
  name: 'First Author, Not Refereed',
  orientation: 'h',
  type: 'bar',
  marker: {
    color: 'rgba(255,153,51,1)',
    width: 1
  }
};

var trace4 = {
  x: [{% for x in authors %}{{x.nrart|subtract:x.nrfirst}},{% endfor %}],
  y: [{% for x in authors %}'{{x.aname}}',{% endfor %}],
  name: 'Not Refereed',
  orientation: 'h',
  type: 'bar',
  marker: {
    color: 'rgba(255,153,51,0.6)',
    width: 1
  }
};

var data = [trace1, trace2, trace3, trace4];



var layout = {
  title: 'Number of Publications',
  barmode: 'stack',
  autosize: false,
  width: 800,
  height: {{authnum}},
  margin: {
    l: 200,
    r: 50,
    b: 100,
    t: 100,
    pad: 4
    }
};

var config = {
  toImageButtonOptions: {
    format: 'png', // one of png, svg, jpeg, webp
    filename: 'Articles_per_Author_report{{resultset.id}}_{{resultset.created}}',
    //height: 500,
    //width: 700,
    //scale: 1 // Multiply title/legend/axis/canvas sizes by this factor
  }
};


Plotly.newPlot('authorgraph', data, layout, config);
</script>

<script>
var jdata = [{
  type: 'bar',
  x: [{% for y in journals %}{{y.articlenum}},{% endfor %}],
  y: [{% for y in journals %}'{{y.jname}}',{% endfor %}],
  orientation: 'h'
}];

var jlayout = {
  title: 'Number of Publications',
  barmode: 'stack',
  autosize: false,
  width: 900,
  height: {{jnum}},
  margin: {
    l: 500,
    r: 50,
    b: 100,
    t: 100,
    pad: 4
    }
};

var jconfig = {
  toImageButtonOptions: {
    format: 'png', // one of png, svg, jpeg, webp
    filename: 'Articles_per_Journal_report{{resultset.id}}_{{resultset.created}}',
    //height: 500,
    //width: 700,
    //scale: 1 // Multiply title/legend/axis/canvas sizes by this factor
  }
};

Plotly.newPlot('journalgraph', jdata, jlayout, jconfig);
</script>



{% endblock %}